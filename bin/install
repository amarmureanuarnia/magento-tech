#!/bin/bash
source "${PWD}"/.tech/.bootstrap
source "${PWD}"/.tech/stack/.env-file

"${BIN_DIRECTORY}"/env/build

echo "Grant permissions to application files ..."
"${BIN_DIRECTORY}"/utility/rootnotty chown -R www-data:www-data /app
"${BIN_DIRECTORY}"/utility/rootnotty chown -R www-data:www-data /var/www/.composer

echo "Clean static files ..."
"${BIN_DIRECTORY}"/utility/rootnotty rm -rf pub/static/*
"${BIN_DIRECTORY}"/utility/rootnotty rm -rf var/page_cache/*
"${BIN_DIRECTORY}"/utility/rootnotty rm -rf var/view_preprocessed/*

echo "Install required packages ..."
"${BIN_DIRECTORY}"/utility/clinotty composer install -n --prefer-dist
"${BIN_DIRECTORY}"/sync-vendor

echo "Run magento administrative tasks ..."
"${BIN_DIRECTORY}"/utility/clinotty bin/magento setup:upgrade
"${BIN_DIRECTORY}"/utility/clinotty bin/magento setup:di:compile
"${BIN_DIRECTORY}"/sync-generated
"${BIN_DIRECTORY}"/utility/clinotty bin/magento setup:static-content:deploy -f --jobs=10
"${BIN_DIRECTORY}"/utility/clinotty bin/magento indexer:reindex
"${BIN_DIRECTORY}"/utility/clinotty bin/magento cache:enable

if [ ! $(sed -n "/${HOST}/=" /etc/hosts) ]; then
  echo "Create a DNS host entry for the application"
  echo "127.0.0.1 ${HOST}" | sudo tee -a /etc/hosts
fi

echo "Application installed successfully."
echo "Open: http://${HOST}"
